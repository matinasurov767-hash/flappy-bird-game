<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird by Matin</title>
    
    <!-- PWA –º–∞–Ω–∏—Ñ–µ—Å—Ç -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E90FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        #game-container {
            max-width: 100%;
            max-height: 100%;
            position: relative;
        }
        #ad-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        #sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1000;
        }
        #performance-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 2000;
        }
        #fps-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="ad-container">–†–µ–∫–ª–∞–º–∞ ¬∑ –ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</div>
    <button id="sound-toggle">üîä</button>
    <div id="performance-warning">
        <h3>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h3>
        <p>–ò–≥—Ä–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã...</p>
    </div>
    <div id="fps-counter">FPS: 60</div>
    
    <script>
        // =============================================
        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –î–õ–Ø TELEGRAM WEBVIEW
        // =============================================
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if (window.Telegram?.WebApp) {
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è Telegram WebView
            document.addEventListener('DOMContentLoaded', function() {
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑—É–º –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) e.preventDefault();
                }, { passive: false });
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
                document.addEventListener('selectstart', function(e) {
                    e.preventDefault();
                });
            });
        }

        // =============================================
        // –ú–û–ù–ò–¢–û–†–ò–ù–ì –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò
        // =============================================
        class PerformanceMonitor {
            constructor() {
                this.fps = 60;
                this.lastTime = performance.now();
                this.frameCount = 0;
                this.fpsCounter = document.getElementById('fps-counter');
                this.warningElement = document.getElementById('performance-warning');
                this.lowFpsCount = 0;
                
                // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø–æ–∫–∞–∑ FPS
                // this.fpsCounter.style.display = 'block';
            }
            
            update() {
                this.frameCount++;
                const currentTime = performance.now();
                
                if (currentTime >= this.lastTime + 1000) {
                    this.fps = Math.round((this.frameCount * 1000) / (currentTime - this.lastTime));
                    this.lastTime = currentTime;
                    this.frameCount = 0;
                    
                    this.fpsCounter.textContent = `FPS: ${this.fps}`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–∏–∑–∫–∏–π FPS
                    if (this.fps < 30) {
                        this.lowFpsCount++;
                        if (this.lowFpsCount > 5) {
                            this.showWarning();
                        }
                    } else {
                        this.lowFpsCount = 0;
                        this.hideWarning();
                    }
                }
            }
            
            showWarning() {
                this.warningElement.style.display = 'block';
                setTimeout(() => {
                    this.hideWarning();
                }, 2000);
            }
            
            hideWarning() {
                this.warningElement.style.display = 'none';
            }
        }

        const performanceMonitor = new PerformanceMonitor();

        // =============================================
        // –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° TELEGRAM –° –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ï–ô
        // =============================================
        let tg = window.Telegram?.WebApp;
        if (tg) {
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è Telegram
            tg.ready();
            tg.expand();
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            setTimeout(() => {
                if (tg.isExpanded) {
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
                }
            }, 1000);
        }

        // =============================================
        // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ú–ï–ù–ï–î–ñ–ï–† –†–ï–ö–õ–ê–ú–´
        // =============================================
        class AdManager {
            constructor() {
                this.adInterval = 3;
                this.gamesPlayed = 0;
                this.adContainer = document.getElementById('ad-container');
            }

            showInterstitial() {
                this.gamesPlayed++;
                if (this.gamesPlayed >= this.adInterval) {
                    this.gamesPlayed = 0;
                    // –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ–∫–∞–∑ —Ä–µ–∫–ª–∞–º—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–∞–≥–æ–≤
                    setTimeout(() => this.showAd(), 100);
                }
            }

            showAd() {
                this.adContainer.style.display = 'block';
                this.adContainer.textContent = '–†–µ–∫–ª–∞–º–∞ ¬∑ –ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ Matin';
                
                setTimeout(() => {
                    this.adContainer.style.display = 'none';
                }, 5000);
            }
        }

        const adManager = new AdManager();

        // =============================================
        // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ú–ï–ù–ï–î–ñ–ï–† –ó–í–£–ö–ê
        // =============================================
        class OptimizedSoundManager {
            constructor() {
                this.sounds = {};
                this.muted = true; // –ù–∞—á–∏–Ω–∞–µ–º —Å –≤—ã–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –∑–≤—É–∫–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                this.soundToggle = document.getElementById('sound-toggle');
                this.audioContext = null;
                this.audioUnlocked = false;
                
                this.soundToggle.addEventListener('click', () => {
                    this.toggleMute();
                });

                // –í Telegram WebView –∑–≤—É–∫ –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ª–∞–≥–∏, –ø–æ—ç—Ç–æ–º—É –Ω–∞—á–∏–Ω–∞–µ–º —Å –≤—ã–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ
                this.soundToggle.textContent = 'üîá';
            }

            addSound(key, config) {
                this.sounds[key] = config;
            }

            playSound(key, volume = 1) {
                if (this.muted || !this.audioUnlocked) return;
                
                const sound = this.sounds[key];
                if (sound && sound.audio) {
                    try {
                        const audio = new Audio();
                        audio.src = sound.audio;
                        audio.volume = volume * (sound.volume || 1);
                        
                        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –ª–∞–≥–æ–≤
                        audio.preload = 'auto';
                        
                        const playPromise = audio.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(() => {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                            });
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                    }
                }
            }

            toggleMute() {
                this.muted = !this.muted;
                this.soundToggle.textContent = this.muted ? 'üîá' : 'üîä';
                
                if (!this.muted && !this.audioUnlocked) {
                    this.unlockAudio();
                }
            }

            unlockAudio() {
                this.audioUnlocked = true;
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ç–∏—Ö–∏–π –∑–≤—É–∫ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞—É–¥–∏–æ
                try {
                    const audio = new Audio();
                    audio.volume = 0.01;
                    audio.play().then(() => {
                        audio.pause();
                    }).catch(() => {});
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                }
            }
        }

        const soundManager = new OptimizedSoundManager();

        // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤—É–∫–∏
        soundManager.addSound('flap', { audio: 'sounds/flap.wav', volume: 0.3 });
        soundManager.addSound('score', { audio: 'sounds/score.wav', volume: 0.5 });
        soundManager.addSound('hit', { audio: 'sounds/hit.wav', volume: 0.7 });
        soundManager.addSound('background', { audio: 'sounds/background.mp3', volume: 0.2 });

        // =============================================
        // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø PHASER
        // =============================================
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 360,
            height: 640,
            physics: { 
                default: 'arcade', 
                arcade: { 
                    gravity: { y: 800 },
                    debug: false,
                    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ñ–∏–∑–∏–∫–∏
                    fps: 60,
                    timeScale: 1,
                    fixedStep: true
                } 
            },
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            render: {
                antialias: false,
                pixelArt: false,
                roundPixels: true // –£–º–µ–Ω—å—à–∞–µ—Ç –¥—Ä–æ–∂–∞–Ω–∏–µ
            },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å—Ü–µ–Ω
            scene: {
                preload: function() {},
                create: function() {}, 
                update: function() {}
            },
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            fps: {
                target: 60,
                forceSetTimeOut: false // –õ—É—á—à–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            },
            backgroundColor: '#000000'
        };

        const game = new Phaser.Game(config);

        // =============================================
        // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –°–¶–ï–ù–ê –ó–ê–°–¢–ê–í–ö–ò
        // =============================================
        class OptimizedSplashScene extends Phaser.Scene {
            constructor() {
                super({ key: 'SplashScene' });
            }

            preload() {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Å—Å–µ—Ç—ã —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
                this.load.image('bird', 'assets/bird.png');
                this.load.image('pipe', 'assets/pipe.png');
                this.load.image('background', 'assets/background.png');
            }

            create() {
                // –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ–Ω –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–∏
                this.cameras.main.setBackgroundColor(0x1a1a2e);

                // –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç
                const title = this.add.text(config.width/2, 200, 'FLAPPY BIRD', {
                    fontSize: '32px',
                    fill: '#FFD700'
                }).setOrigin(0.5);

                const startButton = this.add.text(config.width/2, 350, '–ù–ê–ß–ê–¢–¨ –ò–ì–†–£', {
                    fontSize: '20px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setInteractive();

                startButton.on('pointerdown', () => {
                    this.scene.start('MainGame');
                });

                // –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥
                this.time.delayedCall(2000, () => {
                    this.scene.start('MainGame');
                });
            }
        }

        // =============================================
        // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –û–°–ù–û–í–ù–ê–Ø –ò–ì–†–ê
        // =============================================
        class OptimizedMainGame extends Phaser.Scene {
            constructor() {
                super({ key: 'MainGame' });
                this.pipesToRemove = [];
            }

            init() {
                this.score = 0;
                this.gameOver = false;
                this.pipeTimer = null;
                this.lastPipeTime = 0;
                this.pipeCount = 0;
                this.maxPipes = 6; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä—É–±
            }

            create() {
                // –§–æ–Ω
                this.background = this.add.image(config.width/2, config.height/2, 'background')
                    .setDisplaySize(config.width, config.height);

                // –ü—Ç–∏—Ü–∞
                this.bird = this.physics.add.sprite(80, config.height/2, 'bird');
                this.bird.setCollideWorldBounds(true);
                
                // –¢—Ä—É–±—ã
                this.pipes = this.physics.add.group();
                
                // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∫–æ–ª–ª–∞–π–¥–µ—Ä
                this.physics.add.collider(this.bird, this.pipes, this.hitPipe, null, this);
                
                // –°—á–µ—Ç
                this.scoreText = this.add.text(20, 20, '0', { 
                    fontSize: '20px', 
                    fill: '#FFF'
                });

                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                this.input.on('pointerdown', this.flap, this);
                
                // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä—É–±
                this.pipeTimer = this.time.addEvent({ 
                    delay: 1500, 
                    callback: this.addPipe, 
                    callbackScope: this, 
                    loop: true 
                });

                // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                this.performanceCheck = this.time.addEvent({
                    delay: 1000,
                    callback: this.performanceOptimization,
                    callbackScope: this,
                    loop: true
                });
            }

            update(time, delta) {
                performanceMonitor.update();
                
                if (this.gameOver) return;
                
                // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞ –ø—Ç–∏—Ü—ã
                if (this.bird.body.velocity.y < 0) {
                    this.bird.rotation = -0.3;
                } else {
                    this.bird.rotation = Math.min(this.bird.body.velocity.y / 400, 0.5);
                }
                
                // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
                if (this.bird.y > config.height - 10 || this.bird.y < -10) {
                    this.endGame();
                }
                
                // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä—É–±
                let scoreChanged = false;
                this.pipes.children.iterate(pipe => {
                    // –£–¥–∞–ª—è–µ–º —Ç—Ä—É–±—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—à–ª–∏ –∑–∞ —ç–∫—Ä–∞–Ω
                    if (pipe.x < -100) {
                        this.pipes.remove(pipe, true, true);
                        this.pipeCount--;
                        return;
                    }

                    if (!pipe.passed && pipe.x < this.bird.x - 10) {
                        pipe.passed = true;
                        this.score += 0.5;
                        scoreChanged = true;
                        soundManager.playSound('score');
                    }
                });

                if (scoreChanged) {
                    this.scoreText.setText(Math.floor(this.score));
                }
            }

            flap() {
                if (this.gameOver) return;
                this.bird.setVelocityY(-350);
                soundManager.playSound('flap');
            }

            addPipe() {
                if (this.gameOver || this.pipeCount >= this.maxPipes) return;
                
                const gap = 180;
                const holePosition = Phaser.Math.Between(120, config.height - 120);
                
                // –í–µ—Ä—Ö–Ω—è—è —Ç—Ä—É–±–∞
                const topPipe = this.pipes.create(config.width, holePosition - gap/2, 'pipe');
                topPipe.setOrigin(0.5, 1);
                topPipe.setImmovable(true);
                topPipe.body.allowGravity = false;
                topPipe.setVelocityX(-200);
                
                // –ù–∏–∂–Ω—è—è —Ç—Ä—É–±–∞  
                const bottomPipe = this.pipes.create(config.width, holePosition + gap/2, 'pipe');
                bottomPipe.setOrigin(0.5, 0);
                bottomPipe.setImmovable(true);
                bottomPipe.body.allowGravity = false;
                bottomPipe.setVelocityX(-200);
                
                this.pipeCount += 2;
            }

            performanceOptimization() {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–∏–∑–∫–æ–º FPS
                if (performanceMonitor.fps < 30) {
                    // –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–∏—Ü, —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
                    if (this.pipeTimer) {
                        this.pipeTimer.delay = Math.max(2000, this.pipeTimer.delay + 100);
                    }
                } else if (performanceMonitor.fps > 50) {
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
                    if (this.pipeTimer) {
                        this.pipeTimer.delay = Math.min(1500, this.pipeTimer.delay - 100);
                    }
                }
            }

            hitPipe() {
                if (!this.gameOver) {
                    this.endGame();
                }
            }

            endGame() {
                if (this.gameOver) return;
                
                this.gameOver = true;
                this.bird.setTint(0xFF0000);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä—ã
                if (this.pipeTimer) this.pipeTimer.remove();
                if (this.performanceCheck) this.performanceCheck.remove();
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä—É–±—ã
                this.pipes.children.iterate(pipe => {
                    pipe.setVelocityX(0);
                });
                
                soundManager.playSound('hit');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–æ—Ä–¥
                const finalScore = Math.floor(this.score);
                const bestScore = localStorage.getItem('flappyBestScore') || 0;
                if (finalScore > bestScore) {
                    localStorage.setItem('flappyBestScore', finalScore);
                }
                
                // –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥
                this.time.delayedCall(800, () => {
                    this.scene.start('GameOverScene', { 
                        score: finalScore,
                        bestScore: Math.max(finalScore, bestScore)
                    });
                });
            }

            shutdown() {
                // –¢—â–∞—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
                if (this.pipeTimer) this.pipeTimer.remove();
                if (this.performanceCheck) this.performanceCheck.remove();
                this.pipes.clear(true, true);
                this.input.off('pointerdown', this.flap, this);
            }
        }

        // =============================================
        // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –°–¶–ï–ù–ê –ö–û–ù–¶–ê –ò–ì–†–´
        // =============================================
        class OptimizedGameOverScene extends Phaser.Scene {
            constructor() {
                super({ key: 'GameOverScene' });
            }

            init(data) {
                this.score = data.score;
                this.bestScore = data.bestScore;
            }

            create() {
                // –ü—Ä–æ—Å—Ç–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                this.add.text(config.width/2, config.height/2 - 50, '–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê', {
                    fontSize: '20px',
                    fill: '#FF6B6B'
                }).setOrigin(0.5);

                this.add.text(config.width/2, config.height/2, `–°—á—ë—Ç: ${this.score}`, {
                    fontSize: '24px',
                    fill: '#FFD700'
                }).setOrigin(0.5);

                const restartButton = this.add.text(config.width/2, config.height/2 + 50, '–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê', {
                    fontSize: '16px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 15, y: 8 }
                }).setOrigin(0.5).setInteractive();

                restartButton.on('pointerdown', () => {
                    this.scene.start('MainGame');
                });

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
                if (tg) {
                    tg.sendData(JSON.stringify({ 
                        action: 'game_over',
                        score: this.score
                    }));
                }
            }
        }

        // =============================================
        // –ó–ê–ü–£–°–ö –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–• –°–¶–ï–ù
        // =============================================
        game.scene.add('SplashScene', OptimizedSplashScene);
        game.scene.add('MainGame', OptimizedMainGame);
        game.scene.add('GameOverScene', OptimizedGameOverScene);
        game.scene.start('SplashScene');

        // =============================================
        // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò –î–õ–Ø TELEGRAM
        // =============================================
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.addEventListener('touchmove', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–±–∏–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            document.body.style.webkitBackfaceVisibility = 'hidden';
            document.body.style.webkitTransformStyle = 'preserve-3d';
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', function() {
            if (game && game.destroy) {
                game.destroy(true);
            }
        });

        console.log('–ò–≥—Ä–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è Telegram WebView');
    </script>
</body>
</html>
