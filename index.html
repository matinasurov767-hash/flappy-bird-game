<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird by Matin</title>
    
    <!-- PWA –º–∞–Ω–∏—Ñ–µ—Å—Ç -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E90FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        #game-container {
            max-width: 100%;
            max-height: 100%;
            position: relative;
        }
        #ad-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        #sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="ad-container">–†–µ–∫–ª–∞–º–∞ ¬∑ –ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</div>
    <button id="sound-toggle">üîä</button>
    
    <script>
        // =============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // =============================================
        let tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
        }

        // =============================================
        // –ú–ï–ù–ï–î–ñ–ï–† –†–ï–ö–õ–ê–ú–´
        // =============================================
        class AdManager {
            constructor() {
                this.adInterval = 3;
                this.gamesPlayed = 0;
                this.adContainer = document.getElementById('ad-container');
            }

            showInterstitial() {
                this.gamesPlayed++;
                if (this.gamesPlayed >= this.adInterval) {
                    this.gamesPlayed = 0;
                    this.showAd();
                }
            }

            showAd() {
                this.adContainer.style.display = 'block';
                this.adContainer.textContent = '–†–µ–∫–ª–∞–º–∞ ¬∑ –ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ Matin';
                
                setTimeout(() => {
                    this.adContainer.style.display = 'none';
                }, 5000);
            }

            showRewardedAd() {
                return new Promise((resolve) => {
                    this.adContainer.style.display = 'block';
                    this.adContainer.innerHTML = '–†–µ–∫–ª–∞–º–∞ ¬∑ –ü–æ–ª—É—á–∏—Ç–µ +10 –æ—á–∫–æ–≤<br><small>–ó–∞–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫</small>';
                    
                    setTimeout(() => {
                        this.adContainer.style.display = 'none';
                        resolve(true);
                    }, 3000);
                });
            }
        }

        const adManager = new AdManager();

        // =============================================
        // –ú–ï–ù–ï–î–ñ–ï–† –ó–í–£–ö–ê
        // =============================================
        class SoundManager {
            constructor() {
                this.sounds = {};
                this.muted = false;
                this.soundToggle = document.getElementById('sound-toggle');
                this.backgroundMusic = null;
                
                this.soundToggle.addEventListener('click', () => {
                    this.toggleMute();
                });

                this.initializeSounds();
            }

            initializeSounds() {
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤—É–∫–∏ –∏–∑ –ø–∞–ø–∫–∏ sounds
                this.addSound('flap', {
                    audio: 'sounds/flap.wav',
                    volume: 0.3
                });

                this.addSound('score', {
                    audio: 'sounds/score.wav',
                    volume: 0.5
                });

                this.addSound('hit', {
                    audio: 'sounds/hit.wav',
                    volume: 0.7
                });

                this.addSound('background', {
                    audio: 'sounds/background.mp3',
                    volume: 0.2
                });
            }

            addSound(key, config) {
                this.sounds[key] = config;
            }

            playSound(key, volume = 1) {
                if (this.muted) return;
                
                const sound = this.sounds[key];
                if (sound && sound.audio) {
                    const audio = new Audio(sound.audio);
                    audio.volume = volume * (sound.volume || 1);
                    audio.play().catch(e => console.log('Audio play failed:', e));
                }
            }

            playBackgroundMusic() {
                if (this.muted) return;
                
                const bgSound = this.sounds['background'];
                if (bgSound && !this.backgroundMusic) {
                    this.backgroundMusic = new Audio(bgSound.audio);
                    this.backgroundMusic.volume = bgSound.volume || 0.3;
                    this.backgroundMusic.loop = true;
                    this.backgroundMusic.play().catch(e => console.log('Background music play failed:', e));
                }
            }

            stopBackgroundMusic() {
                if (this.backgroundMusic) {
                    this.backgroundMusic.pause();
                    this.backgroundMusic.currentTime = 0;
                    this.backgroundMusic = null;
                }
            }

            toggleMute() {
                this.muted = !this.muted;
                this.soundToggle.textContent = this.muted ? 'üîá' : 'üîä';
                
                if (this.muted) {
                    this.stopBackgroundMusic();
                } else {
                    this.playBackgroundMusic();
                }
            }
        }

        const soundManager = new SoundManager();

        // =============================================
        // –ú–ï–ù–ï–î–ñ–ï–† –û–ù–õ–ê–ô–ù –¢–ê–ë–õ–ò–¶–´ –õ–ò–î–ï–†–û–í
        // =============================================
        class OnlineLeaderboardManager {
            constructor() {
                this.apiUrl = 'https://your-backend-url.com/api'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
                this.leaderboard = [];
                this.userRank = 0;
            }

            async submitScore(score, userData) {
                try {
                    if (!tg || !tg.initDataUnsafe.user) {
                        console.log('Telegram user data not available');
                        return;
                    }

                    const response = await fetch(`${this.apiUrl}/leaderboard`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            score: score,
                            user_id: tg.initDataUnsafe.user.id,
                            first_name: tg.initDataUnsafe.user.first_name,
                            last_name: tg.initDataUnsafe.user.last_name || '',
                            username: tg.initDataUnsafe.user.username || '',
                            difficulty: userData.difficulty
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to submit score');
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error submitting score:', error);
                    // Fallback to localStorage
                    this.submitScoreToLocalStorage(score, userData);
                }
            }

            async getLeaderboard() {
                try {
                    const response = await fetch(`${this.apiUrl}/leaderboard`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch leaderboard');
                    }
                    
                    const data = await response.json();
                    this.leaderboard = data.leaderboard || [];
                    this.userRank = data.userRank || 0;
                    
                    return this.leaderboard;
                } catch (error) {
                    console.error('Error fetching leaderboard:', error);
                    // Fallback to localStorage
                    return this.getLocalLeaderboard();
                }
            }

            // Fallback –º–µ—Ç–æ–¥—ã –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
            submitScoreToLocalStorage(score, userData) {
                const leaderboard = JSON.parse(localStorage.getItem('onlineLeaderboard') || '[]');
                const user = tg?.initDataUnsafe?.user;
                
                const entry = {
                    score: score,
                    user_id: user?.id || 'anonymous',
                    first_name: user?.first_name || '–ò–≥—Ä–æ–∫',
                    last_name: user?.last_name || '',
                    username: user?.username || '',
                    difficulty: userData.difficulty,
                    timestamp: Date.now()
                };

                leaderboard.push(entry);
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Å—á–µ—Ç–∞ –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ø-50
                leaderboard.sort((a, b) => b.score - a.score);
                const topScores = leaderboard.slice(0, 50);
                
                localStorage.setItem('onlineLeaderboard', JSON.stringify(topScores));
            }

            getLocalLeaderboard() {
                const leaderboard = JSON.parse(localStorage.getItem('onlineLeaderboard') || '[]');
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é
                leaderboard.sort((a, b) => b.score - a.score);
                return leaderboard.slice(0, 10); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø-10
            }

            getUserRank() {
                return this.userRank;
            }
        }

        const onlineLeaderboard = new OnlineLeaderboardManager();

        // =============================================
        // –ú–ï–ù–ï–î–ñ–ï–† –°–¢–ê–¢–ò–°–¢–ò–ö–ò
        // =============================================
        class StatsManager {
            constructor() {
                this.bestScoreKey = 'flappyBestScore';
                this.gamesPlayedKey = 'flappyGamesPlayed';
                this.totalScoreKey = 'flappyTotalScore';
            }

            getBestScore() {
                return parseInt(localStorage.getItem(this.bestScoreKey)) || 0;
            }

            setBestScore(score) {
                const currentBest = this.getBestScore();
                if (score > currentBest) {
                    localStorage.setItem(this.bestScoreKey, score);
                    return true;
                }
                return false;
            }

            incrementGamesPlayed() {
                const games = parseInt(localStorage.getItem(this.gamesPlayedKey)) || 0;
                localStorage.setItem(this.gamesPlayedKey, games + 1);
            }

            getGamesPlayed() {
                return parseInt(localStorage.getItem(this.gamesPlayedKey)) || 0;
            }

            addToTotalScore(score) {
                const total = parseInt(localStorage.getItem(this.totalScoreKey)) || 0;
                localStorage.setItem(this.totalScoreKey, total + score);
            }

            getTotalScore() {
                return parseInt(localStorage.getItem(this.totalScoreKey)) || 0;
            }

            getAverageScore() {
                const total = this.getTotalScore();
                const games = this.getGamesPlayed();
                return games > 0 ? Math.round(total / games) : 0;
            }

            getAchievements(bestScore) {
                const achievements = [];
                
                if (bestScore >= 5) achievements.push('–ù–æ–≤–∏—á–æ–∫ (5 –æ—á–∫–æ–≤)');
                if (bestScore >= 10) achievements.push('–õ—é–±–∏—Ç–µ–ª—å (10 –æ—á–∫–æ–≤)');
                if (bestScore >= 20) achievements.push('–≠–∫—Å–ø–µ—Ä—Ç (20 –æ—á–∫–æ–≤)');
                if (bestScore >= 50) achievements.push('–ú–∞—Å—Ç–µ—Ä (50 –æ—á–∫–æ–≤)');
                if (bestScore >= 100) achievements.push('–õ–µ–≥–µ–Ω–¥–∞ (100 –æ—á–∫–æ–≤)');
                
                return achievements.length > 0 ? achievements : ['–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π'];
            }
        }

        const statsManager = new StatsManager();

        // =============================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ì–†–´
        // =============================================
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 360,
            height: 640,
            physics: { 
                default: 'arcade', 
                arcade: { 
                    gravity: { y: 800 },
                    debug: false
                } 
            },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            }
        };

        const game = new Phaser.Game(config);

        // =============================================
        // –°–¶–ï–ù–ê –ó–ê–°–¢–ê–í–ö–ò
        // =============================================
        class SplashScene extends Phaser.Scene {
            constructor() {
                super({ key: 'SplashScene' });
            }

            preload() {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Å—Å–µ—Ç—ã
                this.load.image('bird', 'assets/bird.png');
                this.load.image('pipe', 'assets/pipe.png');
                this.load.image('background', 'assets/background.png');

                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const progressBox = this.add.graphics();
                progressBox.fillStyle(0x222222, 0.8);
                progressBox.fillRect(110, 270, 140, 30);

                const progressBar = this.add.graphics();
                
                this.load.on('progress', (value) => {
                    progressBar.clear();
                    progressBar.fillStyle(0x1E90FF, 1);
                    progressBar.fillRect(115, 275, 130 * value, 20);
                });

                this.load.on('complete', () => {
                    progressBar.destroy();
                    progressBox.destroy();
                });
            }

            create() {
                // –§–æ–Ω
                this.cameras.main.setBackgroundColor(0x1a1a2e);

                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                this.add.text(config.width/2, 150, 'FLAPPY BIRD', {
                    fontSize: '32px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                const developer = this.add.text(config.width/2, 190, 'by MATIN', {
                    fontSize: '18px',
                    fill: '#FFFFFF'
                }).setOrigin(0.5);

                // –õ—É—á—à–∏–π —Å—á–µ—Ç
                const bestScore = statsManager.getBestScore();
                const bestScoreText = this.add.text(config.width/2, 230, `–†–µ–∫–æ—Ä–¥: ${bestScore}`, {
                    fontSize: '16px',
                    fill: '#CCCCCC'
                }).setOrigin(0.5);

                // –í—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                const difficulties = ['easy', 'medium', 'hard'];
                const difficultyLabels = ['–õ—ë–≥–∫–∏–π', '–°—Ä–µ–¥–Ω–∏–π', '–°–ª–æ–∂–Ω—ã–π'];
                let selectedDifficulty = 'medium';

                for (let i = 0; i < difficulties.length; i++) {
                    const diffButton = this.add.text(config.width/2, 280 + i * 50, difficultyLabels[i], {
                        fontSize: '20px',
                        fill: '#FFFFFF',
                        backgroundColor: difficulties[i] === selectedDifficulty ? '#1565C0' : '#1E90FF',
                        padding: { x: 20, y: 10 }
                    }).setOrigin(0.5).setInteractive();

                    diffButton.on('pointerover', () => {
                        diffButton.setBackgroundColor('#1565C0');
                    });

                    diffButton.on('pointerout', () => {
                        diffButton.setBackgroundColor(difficulties[i] === selectedDifficulty ? '#1565C0' : '#1E90FF');
                    });

                    diffButton.on('pointerdown', () => {
                        // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π
                        this.children.list.forEach(child => {
                            if (child.text && difficultyLabels.includes(child.text)) {
                                const index = difficultyLabels.indexOf(child.text);
                                child.setBackgroundColor(difficulties[index] === selectedDifficulty ? '#1565C0' : '#1E90FF');
                            }
                        });
                        selectedDifficulty = difficulties[i];
                        diffButton.setBackgroundColor('#1565C0');
                    });
                }

                // –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
                const startButton = this.add.text(config.width/2, 450, '–ù–ê–ß–ê–¢–¨ –ò–ì–†–£', {
                    fontSize: '20px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setInteractive();

                startButton.on('pointerover', () => {
                    startButton.setBackgroundColor('#1565C0');
                });

                startButton.on('pointerout', () => {
                    startButton.setBackgroundColor('#1E90FF');
                });

                startButton.on('pointerdown', () => {
                    this.startGame(selectedDifficulty);
                });

                // –ö–Ω–æ–ø–∫–∞ –æ–Ω–ª–∞–π–Ω —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
                const leaderboardButton = this.add.text(config.width/2, 520, '–û–ù–õ–ê–ô–ù –¢–ê–ë–õ–ò–¶–ê', {
                    fontSize: '16px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 15, y: 8 }
                }).setOrigin(0.5).setInteractive();

                leaderboardButton.on('pointerover', () => {
                    leaderboardButton.setBackgroundColor('#1565C0');
                });

                leaderboardButton.on('pointerout', () => {
                    leaderboardButton.setBackgroundColor('#1E90FF');
                });

                leaderboardButton.on('pointerdown', () => {
                    this.scene.start('OnlineLeaderboardScene');
                });

                // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                this.time.delayedCall(10000, () => {
                    this.startGame(selectedDifficulty);
                });
            }

            startGame(difficulty) {
                statsManager.incrementGamesPlayed();
                this.scene.start('MainGame', { difficulty: difficulty });
            }
        }

        // =============================================
        // –û–°–ù–û–í–ù–ê–Ø –ò–ì–†–ê
        // =============================================
        class MainGame extends Phaser.Scene {
            constructor() {
                super({ key: 'MainGame' });
            }

            init(data) {
                this.score = 0;
                this.gameOver = false;
                this.pipeTimer = null;
                this.difficulty = data.difficulty || 'medium';
                this.pipeSpeed = this.difficulty === 'easy' ? -150 : this.difficulty === 'hard' ? -250 : -200;
                this.gap = this.difficulty === 'easy' ? 220 : this.difficulty === 'hard' ? 140 : 180;
            }

            create() {
                // –§–æ–Ω
                this.add.image(config.width/2, config.height/2, 'background')
                    .setDisplaySize(config.width, config.height);

                // –ü—Ç–∏—Ü–∞
                this.bird = this.physics.add.sprite(80, config.height/2, 'bird');
                this.bird.setCollideWorldBounds(true);
                
                // –¢—Ä—É–±—ã
                this.pipes = this.physics.add.group();
                
                // –ö–æ–ª–ª–∞–π–¥–µ—Ä
                this.physics.add.collider(this.bird, this.pipes, this.hitPipe, null, this);
                
                // –°—á–µ—Ç
                this.scoreText = this.add.text(20, 20, '–°—á—ë—Ç: 0', { 
                    fontSize: '20px', 
                    fill: '#FFF',
                    stroke: '#000',
                    strokeThickness: 4
                });

                // –õ—É—á—à–∏–π —Å—á–µ—Ç
                this.bestScore = statsManager.getBestScore();
                this.bestScoreText = this.add.text(20, 50, '–†–µ–∫–æ—Ä–¥: ' + this.bestScore, { 
                    fontSize: '14px', 
                    fill: '#FFD700'
                });
                
                // –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                const difficultyText = this.difficulty === 'easy' ? '–õ—ë–≥–∫–∏–π' : this.difficulty === 'hard' ? '–°–ª–æ–∂–Ω—ã–π' : '–°—Ä–µ–¥–Ω–∏–π';
                this.difficultyText = this.add.text(20, 80, '–°–ª–æ–∂–Ω–æ—Å—Ç—å: ' + difficultyText, { 
                    fontSize: '14px', 
                    fill: '#FFFFFF'
                });
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                this.input.on('pointerdown', this.flap, this);
                
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä—É–±
                this.pipeTimer = this.time.addEvent({ 
                    delay: 1500, 
                    callback: this.addPipe, 
                    callbackScope: this, 
                    loop: true 
                });

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –º—É–∑—ã–∫—É
                soundManager.playBackgroundMusic();
            }

            update() {
                if (this.gameOver) return;
                
                // –ü–æ–≤–æ—Ä–æ—Ç –ø—Ç–∏—Ü—ã
                if (this.bird.body.velocity.y < 0) {
                    this.bird.rotation = -0.3;
                } else {
                    this.bird.rotation = Phaser.Math.Clamp(this.bird.body.velocity.y / 400, -0.3, 0.5);
                }
                
                // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
                if (this.bird.y > config.height - 10 || this.bird.y < -10) {
                    this.endGame();
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞
                this.pipes.children.iterate(pipe => {
                    if (!pipe.passed && pipe.x < this.bird.x - 10) {
                        pipe.passed = true;
                        this.score += 0.5;
                        this.scoreText.setText('–°—á—ë—Ç: ' + Math.floor(this.score));
                        soundManager.playSound('score');
                    }
                });
            }

            flap() {
                if (this.gameOver) return;
                this.bird.setVelocityY(-350);
                soundManager.playSound('flap');
            }

            addPipe() {
                if (this.gameOver) return;
                
                const holePosition = Phaser.Math.Between(120, config.height - 120);
                
                // –í–µ—Ä—Ö–Ω—è—è —Ç—Ä—É–±–∞
                const topPipe = this.pipes.create(config.width, holePosition - this.gap/2, 'pipe');
                topPipe.setOrigin(0.5, 1);
                topPipe.setImmovable(true);
                topPipe.body.allowGravity = false;
                topPipe.setVelocityX(this.pipeSpeed);
                
                // –ù–∏–∂–Ω—è—è —Ç—Ä—É–±–∞  
                const bottomPipe = this.pipes.create(config.width, holePosition + this.gap/2, 'pipe');
                bottomPipe.setOrigin(0.5, 0);
                bottomPipe.setImmovable(true);
                bottomPipe.body.allowGravity = false;
                bottomPipe.setVelocityX(this.pipeSpeed);
            }

            hitPipe() {
                if (!this.gameOver) {
                    this.endGame();
                }
            }

            endGame() {
                if (this.gameOver) return;
                
                this.gameOver = true;
                this.bird.setTint(0xFF0000);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç—Ä—É–±
                if (this.pipeTimer) {
                    this.pipeTimer.remove();
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ —Ç—Ä—É–±
                this.pipes.children.iterate(pipe => {
                    pipe.setVelocityX(0);
                });
                
                // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∑–≤—É–∫ —É–¥–∞—Ä–∞
                soundManager.playSound('hit');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const finalScore = Math.floor(this.score);
                const isNewRecord = statsManager.setBestScore(finalScore);
                statsManager.addToTotalScore(finalScore);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–Ω–ª–∞–π–Ω —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
                onlineLeaderboard.submitScore(finalScore, {
                    difficulty: this.difficulty
                });
                
                // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ —Å—Ü–µ–Ω—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
                this.time.delayedCall(1000, () => {
                    this.scene.start('GameOverScene', { 
                        score: finalScore,
                        bestScore: Math.max(finalScore, this.bestScore),
                        isNewRecord: isNewRecord,
                        difficulty: this.difficulty
                    });
                });
            }

            shutdown() {
                // –û—á–∏—â–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ü–µ–Ω—ã
                if (this.pipeTimer) {
                    this.pipeTimer.remove();
                }
                this.pipes.clear(true, true);
                soundManager.stopBackgroundMusic();
            }
        }

        // =============================================
        // –°–¶–ï–ù–ê –ö–û–ù–¶–ê –ò–ì–†–´
        // =============================================
        class GameOverScene extends Phaser.Scene {
            constructor() {
                super({ key: 'GameOverScene' });
            }

            init(data) {
                this.score = data.score;
                this.bestScore = data.bestScore;
                this.isNewRecord = data.isNewRecord;
                this.difficulty = data.difficulty;
            }

            create() {
                // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
                const overlay = this.add.rectangle(0, 0, config.width, config.height, 0x000000, 0.7);
                overlay.setOrigin(0);

                // –ü–∞–Ω–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                const panel = this.add.graphics();
                panel.fillStyle(0x1a1a2e, 1);
                panel.fillRoundedRect(config.width/2 - 120, config.height/2 - 120, 240, 240, 10);

                // –¢–µ–∫—Å—Ç
                this.add.text(config.width/2, config.height/2 - 90, '–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê', {
                    fontSize: '20px',
                    fill: '#FF6B6B',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                if (this.isNewRecord) {
                    this.add.text(config.width/2, config.height/2 - 50, '–ù–û–í–´–ô –†–ï–ö–û–†–î!', {
                        fontSize: '18px',
                        fill: '#FFD700',
                        fontStyle: 'bold'
                    }).setOrigin(0.5);
                }

                this.add.text(config.width/2, config.height/2 - 20, '–°—á—ë—Ç: ' + this.score, {
                    fontSize: '24px',
                    fill: '#FFD700'
                }).setOrigin(0.5);

                this.add.text(config.width/2, config.height/2 + 10, '–†–µ–∫–æ—Ä–¥: ' + this.bestScore, {
                    fontSize: '18px',
                    fill: '#1E90FF'
                }).setOrigin(0.5);

                // –ö–Ω–æ–ø–∫–∞ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
                const restartButton = this.add.text(config.width/2, config.height/2 + 50, '–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê', {
                    fontSize: '16px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 15, y: 8 }
                }).setOrigin(0.5).setInteractive();

                // –ö–Ω–æ–ø–∫–∞ –æ–Ω–ª–∞–π–Ω —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
                const leaderboardButton = this.add.text(config.width/2, config.height/2 + 90, '–û–ù–õ–ê–ô–ù –¢–ê–ë–õ–ò–¶–ê', {
                    fontSize: '16px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 15, y: 8 }
                }).setOrigin(0.5).setInteractive();

                // –ö–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é
                const menuButton = this.add.text(config.width/2, config.height/2 + 130, '–í –ú–ï–ù–Æ', {
                    fontSize: '14px',
                    fill: '#CCCCCC',
                    backgroundColor: '#333333',
                    padding: { x: 15, y: 6 }
                }).setOrigin(0.5).setInteractive();

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
                restartButton.on('pointerover', () => restartButton.setBackgroundColor('#1565C0'));
                restartButton.on('pointerout', () => restartButton.setBackgroundColor('#1E90FF'));
                restartButton.on('pointerdown', () => {
                    adManager.showInterstitial();
                    this.scene.start('MainGame', { difficulty: this.difficulty });
                });

                leaderboardButton.on('pointerover', () => leaderboardButton.setBackgroundColor('#1565C0'));
                leaderboardButton.on('pointerout', () => leaderboardButton.setBackgroundColor('#1E90FF'));
                leaderboardButton.on('pointerdown', () => {
                    this.scene.start('OnlineLeaderboardScene');
                });

                menuButton.on('pointerover', () => menuButton.setBackgroundColor('#555555'));
                menuButton.on('pointerout', () => menuButton.setBackgroundColor('#333333'));
                menuButton.on('pointerdown', () => {
                    this.scene.start('SplashScene');
                });

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
                if (tg) {
                    tg.sendData(JSON.stringify({ 
                        action: 'game_over',
                        score: this.score,
                        user_id: tg.initDataUnsafe.user?.id || 'unknown',
                        difficulty: this.difficulty
                    }));
                }
            }
        }

        // =============================================
        // –°–¶–ï–ù–ê –û–ù–õ–ê–ô–ù –¢–ê–ë–õ–ò–¶–´ –õ–ò–î–ï–†–û–í
        // =============================================
        class OnlineLeaderboardScene extends Phaser.Scene {
            constructor() {
                super({ key: 'OnlineLeaderboardScene' });
            }

            create() {
                // –§–æ–Ω
                this.cameras.main.setBackgroundColor(0x1a1a2e);

                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                this.add.text(config.width/2, 60, '–û–ù–õ–ê–ô–ù –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í', {
                    fontSize: '22px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingText = this.add.text(config.width/2, config.height/2, '–ó–∞–≥—Ä—É–∑–∫–∞...', {
                    fontSize: '18px',
                    fill: '#FFFFFF'
                }).setOrigin(0.5);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
                onlineLeaderboard.getLeaderboard().then(leaderboard => {
                    loadingText.destroy();
                    this.displayLeaderboard(leaderboard);
                }).catch(error => {
                    loadingText.setText('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                    console.error('Error loading leaderboard:', error);
                });

                // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const refreshButton = this.add.text(config.width - 30, 30, 'üîÑ', {
                    fontSize: '20px'
                }).setOrigin(0.5).setInteractive();

                refreshButton.on('pointerdown', () => {
                    this.scene.restart();
                });

                // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
                const backButton = this.add.text(config.width/2, 580, '–ù–ê–ó–ê–î', {
                    fontSize: '18px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setInteractive();

                backButton.on('pointerover', () => {
                    backButton.setBackgroundColor('#1565C0');
                });

                backButton.on('pointerout', () => {
                    backButton.setBackgroundColor('#1E90FF');
                });

                backButton.on('pointerdown', () => {
                    this.scene.start('SplashScene');
                });
            }

            displayLeaderboard(leaderboard) {
                if (leaderboard.length === 0) {
                    this.add.text(config.width/2, config.height/2, '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', {
                        fontSize: '18px',
                        fill: '#FFFFFF'
                    }).setOrigin(0.5);
                    return;
                }

                // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
                this.add.text(30, 100, '–ú–µ—Å—Ç–æ', {
                    fontSize: '14px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                });

                this.add.text(100, 100, '–ò–≥—Ä–æ–∫', {
                    fontSize: '14px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                });

                this.add.text(280, 100, '–û—á–∫–∏', {
                    fontSize: '14px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                });

                // –°–ø–∏—Å–æ–∫ –ª–∏–¥–µ—Ä–æ–≤
                leaderboard.forEach((entry, index) => {
                    const y = 130 + index * 30;
                    
                    // –ú–µ—Å—Ç–æ
                    let medal = '';
                    let medalColor = '#FFFFFF';
                    
                    if (index === 0) {
                        medal = 'ü•á';
                        medalColor = '#FFD700';
                    } else if (index === 1) {
                        medal = 'ü•à';
                        medalColor = '#C0C0C0';
                    } else if (index === 2) {
                        medal = 'ü•â';
                        medalColor = '#CD7F32';
                    }
                    
                    this.add.text(30, y, `${medal} ${index + 1}`, {
                        fontSize: '14px',
                        fill: medalColor
                    });

                    // –ò–º—è –∏–≥—Ä–æ–∫–∞
                    let playerName = entry.first_name || '–ò–≥—Ä–æ–∫';
                    if (entry.last_name) {
                        playerName += ' ' + entry.last_name;
                    }
                    if (playerName.length > 15) {
                        playerName = playerName.substring(0, 15) + '...';
                    }

                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const isCurrentUser = tg && tg.initDataUnsafe.user && 
                                         entry.user_id === tg.initDataUnsafe.user.id;
                    
                    this.add.text(100, y, playerName, {
                        fontSize: '14px',
                        fill: isCurrentUser ? '#1E90FF' : '#FFFFFF',
                        fontStyle: isCurrentUser ? 'bold' : 'normal'
                    });

                    // –û—á–∫–∏
                    this.add.text(280, y, entry.score.toString(), {
                        fontSize: '14px',
                        fill: isCurrentUser ? '#1E90FF' : '#FFFFFF',
                        fontStyle: isCurrentUser ? 'bold' : 'normal'
                    });
                });

                // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
                this.add.text(config.width/2, 550, `–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: ${leaderboard.length}`, {
                    fontSize: '14px',
                    fill: '#CCCCCC'
                }).setOrigin(0.5);
            }
        }

        // =============================================
        // –ó–ê–ü–£–°–ö –°–¶–ï–ù
        // =============================================
        game.scene.add('SplashScene', SplashScene);
        game.scene.add('MainGame', MainGame);
        game.scene.add('GameOverScene', GameOverScene);
        game.scene.add('OnlineLeaderboardScene', OnlineLeaderboardScene);
        game.scene.start('SplashScene');
    </script>
</body>
</html>
