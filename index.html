<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird by Matin</title>
    
    <!-- PWA манифест -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E90FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        #game-container {
            max-width: 100%;
            max-height: 100%;
            position: relative;
        }
        #ad-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        #sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="ad-container">Реклама · Поддержите разработчика</div>
    <button id="sound-toggle">🔊</button>
    
    <script>
        // =============================================
        // ИНИЦИАЛИЗАЦИЯ
        // =============================================
        let tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
        }

        // =============================================
        // МЕНЕДЖЕР РЕКЛАМЫ
        // =============================================
        class AdManager {
            constructor() {
                this.adInterval = 3;
                this.gamesPlayed = 0;
                this.adContainer = document.getElementById('ad-container');
            }

            showInterstitial() {
                this.gamesPlayed++;
                if (this.gamesPlayed >= this.adInterval) {
                    this.gamesPlayed = 0;
                    this.showAd();
                }
            }

            showAd() {
                this.adContainer.style.display = 'block';
                this.adContainer.textContent = 'Реклама · Поддержите разработчика Matin';
                
                setTimeout(() => {
                    this.adContainer.style.display = 'none';
                }, 5000);
            }

            showRewardedAd() {
                return new Promise((resolve) => {
                    this.adContainer.style.display = 'block';
                    this.adContainer.innerHTML = 'Реклама · Получите +10 очков<br><small>Закройте через 3 сек</small>';
                    
                    setTimeout(() => {
                        this.adContainer.style.display = 'none';
                        resolve(true);
                    }, 3000);
                });
            }
        }

        const adManager = new AdManager();

        // =============================================
        // МЕНЕДЖЕР ЗВУКА
        // =============================================
        class SoundManager {
            constructor() {
                this.sounds = {};
                this.muted = false;
                this.soundToggle = document.getElementById('sound-toggle');
                this.backgroundMusic = null;
                
                this.soundToggle.addEventListener('click', () => {
                    this.toggleMute();
                });

                this.initializeSounds();
            }

            initializeSounds() {
                // Добавляем звуки из папки sounds
                this.addSound('flap', {
                    audio: 'sounds/flap.wav',
                    volume: 0.3
                });

                this.addSound('score', {
                    audio: 'sounds/score.wav',
                    volume: 0.5
                });

                this.addSound('hit', {
                    audio: 'sounds/hit.wav',
                    volume: 0.7
                });

                this.addSound('background', {
                    audio: 'sounds/background.mp3',
                    volume: 0.2
                });
            }

            addSound(key, config) {
                this.sounds[key] = config;
            }

            playSound(key, volume = 1) {
                if (this.muted) return;
                
                const sound = this.sounds[key];
                if (sound && sound.audio) {
                    const audio = new Audio(sound.audio);
                    audio.volume = volume * (sound.volume || 1);
                    audio.play().catch(e => console.log('Audio play failed:', e));
                }
            }

            playBackgroundMusic() {
                if (this.muted) return;
                
                const bgSound = this.sounds['background'];
                if (bgSound && !this.backgroundMusic) {
                    this.backgroundMusic = new Audio(bgSound.audio);
                    this.backgroundMusic.volume = bgSound.volume || 0.3;
                    this.backgroundMusic.loop = true;
                    this.backgroundMusic.play().catch(e => console.log('Background music play failed:', e));
                }
            }

            stopBackgroundMusic() {
                if (this.backgroundMusic) {
                    this.backgroundMusic.pause();
                    this.backgroundMusic.currentTime = 0;
                    this.backgroundMusic = null;
                }
            }

            toggleMute() {
                this.muted = !this.muted;
                this.soundToggle.textContent = this.muted ? '🔇' : '🔊';
                
                if (this.muted) {
                    this.stopBackgroundMusic();
                } else {
                    this.playBackgroundMusic();
                }
            }
        }

        const soundManager = new SoundManager();

        // =============================================
        // МЕНЕДЖЕР ОНЛАЙН ТАБЛИЦЫ ЛИДЕРОВ
        // =============================================
        class OnlineLeaderboardManager {
            constructor() {
                this.apiUrl = 'https://your-backend-url.com/api'; // Замените на ваш URL
                this.leaderboard = [];
                this.userRank = 0;
            }

            async submitScore(score, userData) {
                try {
                    if (!tg || !tg.initDataUnsafe.user) {
                        console.log('Telegram user data not available');
                        return;
                    }

                    const response = await fetch(`${this.apiUrl}/leaderboard`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            score: score,
                            user_id: tg.initDataUnsafe.user.id,
                            first_name: tg.initDataUnsafe.user.first_name,
                            last_name: tg.initDataUnsafe.user.last_name || '',
                            username: tg.initDataUnsafe.user.username || '',
                            difficulty: userData.difficulty
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to submit score');
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error submitting score:', error);
                    // Fallback to localStorage
                    this.submitScoreToLocalStorage(score, userData);
                }
            }

            async getLeaderboard() {
                try {
                    const response = await fetch(`${this.apiUrl}/leaderboard`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch leaderboard');
                    }
                    
                    const data = await response.json();
                    this.leaderboard = data.leaderboard || [];
                    this.userRank = data.userRank || 0;
                    
                    return this.leaderboard;
                } catch (error) {
                    console.error('Error fetching leaderboard:', error);
                    // Fallback to localStorage
                    return this.getLocalLeaderboard();
                }
            }

            // Fallback методы для локального хранения
            submitScoreToLocalStorage(score, userData) {
                const leaderboard = JSON.parse(localStorage.getItem('onlineLeaderboard') || '[]');
                const user = tg?.initDataUnsafe?.user;
                
                const entry = {
                    score: score,
                    user_id: user?.id || 'anonymous',
                    first_name: user?.first_name || 'Игрок',
                    last_name: user?.last_name || '',
                    username: user?.username || '',
                    difficulty: userData.difficulty,
                    timestamp: Date.now()
                };

                leaderboard.push(entry);
                
                // Сортируем по убыванию счета и оставляем топ-50
                leaderboard.sort((a, b) => b.score - a.score);
                const topScores = leaderboard.slice(0, 50);
                
                localStorage.setItem('onlineLeaderboard', JSON.stringify(topScores));
            }

            getLocalLeaderboard() {
                const leaderboard = JSON.parse(localStorage.getItem('onlineLeaderboard') || '[]');
                // Сортируем на случай, если данные были добавлены вручную
                leaderboard.sort((a, b) => b.score - a.score);
                return leaderboard.slice(0, 10); // Возвращаем топ-10
            }

            getUserRank() {
                return this.userRank;
            }
        }

        const onlineLeaderboard = new OnlineLeaderboardManager();

        // =============================================
        // МЕНЕДЖЕР СТАТИСТИКИ
        // =============================================
        class StatsManager {
            constructor() {
                this.bestScoreKey = 'flappyBestScore';
                this.gamesPlayedKey = 'flappyGamesPlayed';
                this.totalScoreKey = 'flappyTotalScore';
            }

            getBestScore() {
                return parseInt(localStorage.getItem(this.bestScoreKey)) || 0;
            }

            setBestScore(score) {
                const currentBest = this.getBestScore();
                if (score > currentBest) {
                    localStorage.setItem(this.bestScoreKey, score);
                    return true;
                }
                return false;
            }

            incrementGamesPlayed() {
                const games = parseInt(localStorage.getItem(this.gamesPlayedKey)) || 0;
                localStorage.setItem(this.gamesPlayedKey, games + 1);
            }

            getGamesPlayed() {
                return parseInt(localStorage.getItem(this.gamesPlayedKey)) || 0;
            }

            addToTotalScore(score) {
                const total = parseInt(localStorage.getItem(this.totalScoreKey)) || 0;
                localStorage.setItem(this.totalScoreKey, total + score);
            }

            getTotalScore() {
                return parseInt(localStorage.getItem(this.totalScoreKey)) || 0;
            }

            getAverageScore() {
                const total = this.getTotalScore();
                const games = this.getGamesPlayed();
                return games > 0 ? Math.round(total / games) : 0;
            }

            getAchievements(bestScore) {
                const achievements = [];
                
                if (bestScore >= 5) achievements.push('Новичок (5 очков)');
                if (bestScore >= 10) achievements.push('Любитель (10 очков)');
                if (bestScore >= 20) achievements.push('Эксперт (20 очков)');
                if (bestScore >= 50) achievements.push('Мастер (50 очков)');
                if (bestScore >= 100) achievements.push('Легенда (100 очков)');
                
                return achievements.length > 0 ? achievements : ['Пока нет достижений'];
            }
        }

        const statsManager = new StatsManager();

        // =============================================
        // КОНФИГУРАЦИЯ ИГРЫ
        // =============================================
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 360,
            height: 640,
            physics: { 
                default: 'arcade', 
                arcade: { 
                    gravity: { y: 800 },
                    debug: false
                } 
            },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            }
        };

        const game = new Phaser.Game(config);

        // =============================================
        // СЦЕНА ЗАСТАВКИ
        // =============================================
        class SplashScene extends Phaser.Scene {
            constructor() {
                super({ key: 'SplashScene' });
            }

            preload() {
                // Загружаем ассеты
                this.load.image('bird', 'assets/bird.png');
                this.load.image('pipe', 'assets/pipe.png');
                this.load.image('background', 'assets/background.png');

                // Индикатор загрузки
                const progressBox = this.add.graphics();
                progressBox.fillStyle(0x222222, 0.8);
                progressBox.fillRect(110, 270, 140, 30);

                const progressBar = this.add.graphics();
                
                this.load.on('progress', (value) => {
                    progressBar.clear();
                    progressBar.fillStyle(0x1E90FF, 1);
                    progressBar.fillRect(115, 275, 130 * value, 20);
                });

                this.load.on('complete', () => {
                    progressBar.destroy();
                    progressBox.destroy();
                });
            }

            create() {
                // Фон
                this.cameras.main.setBackgroundColor(0x1a1a2e);

                // Заголовок
                this.add.text(config.width/2, 150, 'FLAPPY BIRD', {
                    fontSize: '32px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                const developer = this.add.text(config.width/2, 190, 'by MATIN', {
                    fontSize: '18px',
                    fill: '#FFFFFF'
                }).setOrigin(0.5);

                // Лучший счет
                const bestScore = statsManager.getBestScore();
                const bestScoreText = this.add.text(config.width/2, 230, `Рекорд: ${bestScore}`, {
                    fontSize: '16px',
                    fill: '#CCCCCC'
                }).setOrigin(0.5);

                // Выбор сложности
                const difficulties = ['easy', 'medium', 'hard'];
                const difficultyLabels = ['Лёгкий', 'Средний', 'Сложный'];
                let selectedDifficulty = 'medium';

                for (let i = 0; i < difficulties.length; i++) {
                    const diffButton = this.add.text(config.width/2, 280 + i * 50, difficultyLabels[i], {
                        fontSize: '20px',
                        fill: '#FFFFFF',
                        backgroundColor: difficulties[i] === selectedDifficulty ? '#1565C0' : '#1E90FF',
                        padding: { x: 20, y: 10 }
                    }).setOrigin(0.5).setInteractive();

                    diffButton.on('pointerover', () => {
                        diffButton.setBackgroundColor('#1565C0');
                    });

                    diffButton.on('pointerout', () => {
                        diffButton.setBackgroundColor(difficulties[i] === selectedDifficulty ? '#1565C0' : '#1E90FF');
                    });

                    diffButton.on('pointerdown', () => {
                        // Сброс стилей предыдущей выбранной
                        this.children.list.forEach(child => {
                            if (child.text && difficultyLabels.includes(child.text)) {
                                const index = difficultyLabels.indexOf(child.text);
                                child.setBackgroundColor(difficulties[index] === selectedDifficulty ? '#1565C0' : '#1E90FF');
                            }
                        });
                        selectedDifficulty = difficulties[i];
                        diffButton.setBackgroundColor('#1565C0');
                    });
                }

                // Кнопка начала игры
                const startButton = this.add.text(config.width/2, 450, 'НАЧАТЬ ИГРУ', {
                    fontSize: '20px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setInteractive();

                startButton.on('pointerover', () => {
                    startButton.setBackgroundColor('#1565C0');
                });

                startButton.on('pointerout', () => {
                    startButton.setBackgroundColor('#1E90FF');
                });

                startButton.on('pointerdown', () => {
                    this.startGame(selectedDifficulty);
                });

                // Кнопка онлайн таблицы лидеров
                const leaderboardButton = this.add.text(config.width/2, 520, 'ОНЛАЙН ТАБЛИЦА', {
                    fontSize: '16px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 15, y: 8 }
                }).setOrigin(0.5).setInteractive();

                leaderboardButton.on('pointerover', () => {
                    leaderboardButton.setBackgroundColor('#1565C0');
                });

                leaderboardButton.on('pointerout', () => {
                    leaderboardButton.setBackgroundColor('#1E90FF');
                });

                leaderboardButton.on('pointerdown', () => {
                    this.scene.start('OnlineLeaderboardScene');
                });

                // Автопереход через 10 секунд
                this.time.delayedCall(10000, () => {
                    this.startGame(selectedDifficulty);
                });
            }

            startGame(difficulty) {
                statsManager.incrementGamesPlayed();
                this.scene.start('MainGame', { difficulty: difficulty });
            }
        }

        // =============================================
        // ОСНОВНАЯ ИГРА
        // =============================================
        class MainGame extends Phaser.Scene {
            constructor() {
                super({ key: 'MainGame' });
            }

            init(data) {
                this.score = 0;
                this.gameOver = false;
                this.pipeTimer = null;
                this.difficulty = data.difficulty || 'medium';
                this.pipeSpeed = this.difficulty === 'easy' ? -150 : this.difficulty === 'hard' ? -250 : -200;
                this.gap = this.difficulty === 'easy' ? 220 : this.difficulty === 'hard' ? 140 : 180;
            }

            create() {
                // Фон
                this.add.image(config.width/2, config.height/2, 'background')
                    .setDisplaySize(config.width, config.height);

                // Птица
                this.bird = this.physics.add.sprite(80, config.height/2, 'bird');
                this.bird.setCollideWorldBounds(true);
                
                // Трубы
                this.pipes = this.physics.add.group();
                
                // Коллайдер
                this.physics.add.collider(this.bird, this.pipes, this.hitPipe, null, this);
                
                // Счет
                this.scoreText = this.add.text(20, 20, 'Счёт: 0', { 
                    fontSize: '20px', 
                    fill: '#FFF',
                    stroke: '#000',
                    strokeThickness: 4
                });

                // Лучший счет
                this.bestScore = statsManager.getBestScore();
                this.bestScoreText = this.add.text(20, 50, 'Рекорд: ' + this.bestScore, { 
                    fontSize: '14px', 
                    fill: '#FFD700'
                });
                
                // Уровень сложности
                const difficultyText = this.difficulty === 'easy' ? 'Лёгкий' : this.difficulty === 'hard' ? 'Сложный' : 'Средний';
                this.difficultyText = this.add.text(20, 80, 'Сложность: ' + difficultyText, { 
                    fontSize: '14px', 
                    fill: '#FFFFFF'
                });
                
                // Управление
                this.input.on('pointerdown', this.flap, this);
                
                // Генерация труб
                this.pipeTimer = this.time.addEvent({ 
                    delay: 1500, 
                    callback: this.addPipe, 
                    callbackScope: this, 
                    loop: true 
                });

                // Запускаем фоновую музыку
                soundManager.playBackgroundMusic();
            }

            update() {
                if (this.gameOver) return;
                
                // Поворот птицы
                if (this.bird.body.velocity.y < 0) {
                    this.bird.rotation = -0.3;
                } else {
                    this.bird.rotation = Phaser.Math.Clamp(this.bird.body.velocity.y / 400, -0.3, 0.5);
                }
                
                // Конец игры
                if (this.bird.y > config.height - 10 || this.bird.y < -10) {
                    this.endGame();
                }
                
                // Обновление счета
                this.pipes.children.iterate(pipe => {
                    if (!pipe.passed && pipe.x < this.bird.x - 10) {
                        pipe.passed = true;
                        this.score += 0.5;
                        this.scoreText.setText('Счёт: ' + Math.floor(this.score));
                        soundManager.playSound('score');
                    }
                });
            }

            flap() {
                if (this.gameOver) return;
                this.bird.setVelocityY(-350);
                soundManager.playSound('flap');
            }

            addPipe() {
                if (this.gameOver) return;
                
                const holePosition = Phaser.Math.Between(120, config.height - 120);
                
                // Верхняя труба
                const topPipe = this.pipes.create(config.width, holePosition - this.gap/2, 'pipe');
                topPipe.setOrigin(0.5, 1);
                topPipe.setImmovable(true);
                topPipe.body.allowGravity = false;
                topPipe.setVelocityX(this.pipeSpeed);
                
                // Нижняя труба  
                const bottomPipe = this.pipes.create(config.width, holePosition + this.gap/2, 'pipe');
                bottomPipe.setOrigin(0.5, 0);
                bottomPipe.setImmovable(true);
                bottomPipe.body.allowGravity = false;
                bottomPipe.setVelocityX(this.pipeSpeed);
            }

            hitPipe() {
                if (!this.gameOver) {
                    this.endGame();
                }
            }

            endGame() {
                if (this.gameOver) return;
                
                this.gameOver = true;
                this.bird.setTint(0xFF0000);
                
                // Останавливаем генерацию труб
                if (this.pipeTimer) {
                    this.pipeTimer.remove();
                }
                
                // Останавливаем движение труб
                this.pipes.children.iterate(pipe => {
                    pipe.setVelocityX(0);
                });
                
                // Проигрываем звук удара
                soundManager.playSound('hit');
                
                // Сохраняем статистику
                const finalScore = Math.floor(this.score);
                const isNewRecord = statsManager.setBestScore(finalScore);
                statsManager.addToTotalScore(finalScore);
                
                // Отправляем результат в онлайн таблицу лидеров
                onlineLeaderboard.submitScore(finalScore, {
                    difficulty: this.difficulty
                });
                
                // Задержка перед переходом на сцену окончания
                this.time.delayedCall(1000, () => {
                    this.scene.start('GameOverScene', { 
                        score: finalScore,
                        bestScore: Math.max(finalScore, this.bestScore),
                        isNewRecord: isNewRecord,
                        difficulty: this.difficulty
                    });
                });
            }

            shutdown() {
                // Очищаем ресурсы при закрытии сцены
                if (this.pipeTimer) {
                    this.pipeTimer.remove();
                }
                this.pipes.clear(true, true);
                soundManager.stopBackgroundMusic();
            }
        }

        // =============================================
        // СЦЕНА КОНЦА ИГРЫ
        // =============================================
        class GameOverScene extends Phaser.Scene {
            constructor() {
                super({ key: 'GameOverScene' });
            }

            init(data) {
                this.score = data.score;
                this.bestScore = data.bestScore;
                this.isNewRecord = data.isNewRecord;
                this.difficulty = data.difficulty;
            }

            create() {
                // Полупрозрачный фон
                const overlay = this.add.rectangle(0, 0, config.width, config.height, 0x000000, 0.7);
                overlay.setOrigin(0);

                // Панель результатов
                const panel = this.add.graphics();
                panel.fillStyle(0x1a1a2e, 1);
                panel.fillRoundedRect(config.width/2 - 120, config.height/2 - 120, 240, 240, 10);

                // Текст
                this.add.text(config.width/2, config.height/2 - 90, 'ИГРА ОКОНЧЕНА', {
                    fontSize: '20px',
                    fill: '#FF6B6B',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                if (this.isNewRecord) {
                    this.add.text(config.width/2, config.height/2 - 50, 'НОВЫЙ РЕКОРД!', {
                        fontSize: '18px',
                        fill: '#FFD700',
                        fontStyle: 'bold'
                    }).setOrigin(0.5);
                }

                this.add.text(config.width/2, config.height/2 - 20, 'Счёт: ' + this.score, {
                    fontSize: '24px',
                    fill: '#FFD700'
                }).setOrigin(0.5);

                this.add.text(config.width/2, config.height/2 + 10, 'Рекорд: ' + this.bestScore, {
                    fontSize: '18px',
                    fill: '#1E90FF'
                }).setOrigin(0.5);

                // Кнопка рестарта
                const restartButton = this.add.text(config.width/2, config.height/2 + 50, 'ИГРАТЬ СНОВА', {
                    fontSize: '16px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 15, y: 8 }
                }).setOrigin(0.5).setInteractive();

                // Кнопка онлайн таблицы лидеров
                const leaderboardButton = this.add.text(config.width/2, config.height/2 + 90, 'ОНЛАЙН ТАБЛИЦА', {
                    fontSize: '16px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 15, y: 8 }
                }).setOrigin(0.5).setInteractive();

                // Кнопка в меню
                const menuButton = this.add.text(config.width/2, config.height/2 + 130, 'В МЕНЮ', {
                    fontSize: '14px',
                    fill: '#CCCCCC',
                    backgroundColor: '#333333',
                    padding: { x: 15, y: 6 }
                }).setOrigin(0.5).setInteractive();

                // Обработчики кнопок
                restartButton.on('pointerover', () => restartButton.setBackgroundColor('#1565C0'));
                restartButton.on('pointerout', () => restartButton.setBackgroundColor('#1E90FF'));
                restartButton.on('pointerdown', () => {
                    adManager.showInterstitial();
                    this.scene.start('MainGame', { difficulty: this.difficulty });
                });

                leaderboardButton.on('pointerover', () => leaderboardButton.setBackgroundColor('#1565C0'));
                leaderboardButton.on('pointerout', () => leaderboardButton.setBackgroundColor('#1E90FF'));
                leaderboardButton.on('pointerdown', () => {
                    this.scene.start('OnlineLeaderboardScene');
                });

                menuButton.on('pointerover', () => menuButton.setBackgroundColor('#555555'));
                menuButton.on('pointerout', () => menuButton.setBackgroundColor('#333333'));
                menuButton.on('pointerdown', () => {
                    this.scene.start('SplashScene');
                });

                // Отправка в Telegram
                if (tg) {
                    tg.sendData(JSON.stringify({ 
                        action: 'game_over',
                        score: this.score,
                        user_id: tg.initDataUnsafe.user?.id || 'unknown',
                        difficulty: this.difficulty
                    }));
                }
            }
        }

        // =============================================
        // СЦЕНА ОНЛАЙН ТАБЛИЦЫ ЛИДЕРОВ
        // =============================================
        class OnlineLeaderboardScene extends Phaser.Scene {
            constructor() {
                super({ key: 'OnlineLeaderboardScene' });
            }

            create() {
                // Фон
                this.cameras.main.setBackgroundColor(0x1a1a2e);

                // Заголовок
                this.add.text(config.width/2, 60, 'ОНЛАЙН ТАБЛИЦА ЛИДЕРОВ', {
                    fontSize: '22px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                // Индикатор загрузки
                const loadingText = this.add.text(config.width/2, config.height/2, 'Загрузка...', {
                    fontSize: '18px',
                    fill: '#FFFFFF'
                }).setOrigin(0.5);

                // Загружаем таблицу лидеров
                onlineLeaderboard.getLeaderboard().then(leaderboard => {
                    loadingText.destroy();
                    this.displayLeaderboard(leaderboard);
                }).catch(error => {
                    loadingText.setText('Ошибка загрузки');
                    console.error('Error loading leaderboard:', error);
                });

                // Кнопка обновления
                const refreshButton = this.add.text(config.width - 30, 30, '🔄', {
                    fontSize: '20px'
                }).setOrigin(0.5).setInteractive();

                refreshButton.on('pointerdown', () => {
                    this.scene.restart();
                });

                // Кнопка назад
                const backButton = this.add.text(config.width/2, 580, 'НАЗАД', {
                    fontSize: '18px',
                    fill: '#FFFFFF',
                    backgroundColor: '#1E90FF',
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setInteractive();

                backButton.on('pointerover', () => {
                    backButton.setBackgroundColor('#1565C0');
                });

                backButton.on('pointerout', () => {
                    backButton.setBackgroundColor('#1E90FF');
                });

                backButton.on('pointerdown', () => {
                    this.scene.start('SplashScene');
                });
            }

            displayLeaderboard(leaderboard) {
                if (leaderboard.length === 0) {
                    this.add.text(config.width/2, config.height/2, 'Нет данных', {
                        fontSize: '18px',
                        fill: '#FFFFFF'
                    }).setOrigin(0.5);
                    return;
                }

                // Заголовки столбцов
                this.add.text(30, 100, 'Место', {
                    fontSize: '14px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                });

                this.add.text(100, 100, 'Игрок', {
                    fontSize: '14px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                });

                this.add.text(280, 100, 'Очки', {
                    fontSize: '14px',
                    fill: '#FFD700',
                    fontStyle: 'bold'
                });

                // Список лидеров
                leaderboard.forEach((entry, index) => {
                    const y = 130 + index * 30;
                    
                    // Место
                    let medal = '';
                    let medalColor = '#FFFFFF';
                    
                    if (index === 0) {
                        medal = '🥇';
                        medalColor = '#FFD700';
                    } else if (index === 1) {
                        medal = '🥈';
                        medalColor = '#C0C0C0';
                    } else if (index === 2) {
                        medal = '🥉';
                        medalColor = '#CD7F32';
                    }
                    
                    this.add.text(30, y, `${medal} ${index + 1}`, {
                        fontSize: '14px',
                        fill: medalColor
                    });

                    // Имя игрока
                    let playerName = entry.first_name || 'Игрок';
                    if (entry.last_name) {
                        playerName += ' ' + entry.last_name;
                    }
                    if (playerName.length > 15) {
                        playerName = playerName.substring(0, 15) + '...';
                    }

                    // Подсветка текущего пользователя
                    const isCurrentUser = tg && tg.initDataUnsafe.user && 
                                         entry.user_id === tg.initDataUnsafe.user.id;
                    
                    this.add.text(100, y, playerName, {
                        fontSize: '14px',
                        fill: isCurrentUser ? '#1E90FF' : '#FFFFFF',
                        fontStyle: isCurrentUser ? 'bold' : 'normal'
                    });

                    // Очки
                    this.add.text(280, y, entry.score.toString(), {
                        fontSize: '14px',
                        fill: isCurrentUser ? '#1E90FF' : '#FFFFFF',
                        fontStyle: isCurrentUser ? 'bold' : 'normal'
                    });
                });

                // Общее количество игроков
                this.add.text(config.width/2, 550, `Всего игроков: ${leaderboard.length}`, {
                    fontSize: '14px',
                    fill: '#CCCCCC'
                }).setOrigin(0.5);
            }
        }

        // =============================================
        // ЗАПУСК СЦЕН
        // =============================================
        game.scene.add('SplashScene', SplashScene);
        game.scene.add('MainGame', MainGame);
        game.scene.add('GameOverScene', GameOverScene);
        game.scene.add('OnlineLeaderboardScene', OnlineLeaderboardScene);
        game.scene.start('SplashScene');
    </script>
</body>
</html>
